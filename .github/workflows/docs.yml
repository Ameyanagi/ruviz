name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'examples/doc_*.rs'
      - 'src/**/*.rs'
      - 'docs/**'
  pull_request:
    paths:
      - 'examples/doc_*.rs'
      - 'src/**/*.rs'
      - 'docs/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  check-doc-images:
    name: Check Documentation Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-docs-

      - name: Generate doc images
        run: ./scripts/generate-doc-images.sh

      - name: Check for uncommitted image changes
        run: |
          if [[ -n $(git status --porcelain docs/images/) ]]; then
            echo "::error::Documentation images are out of date!"
            echo "Run './scripts/generate-doc-images.sh' and commit the changes."
            git diff --stat docs/images/
            exit 1
          fi
          echo "Documentation images are up to date."

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-docs-

      - name: Build documentation
        run: cargo doc --no-deps

      - name: Check for broken links
        run: |
          # Check that all image URLs in docs reference existing files
          for img in docs/images/*.png; do
            if [ -f "$img" ]; then
              echo "âœ“ Found: $img"
            fi
          done
